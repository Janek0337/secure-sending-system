{% extends 'base.html' %}

{% block title %}View message{% endblock %}
{% set show_hashes = False %}
{% block content %}
<h2>From: {{ data.sender }}</h2>
<h2>At: {{ data.date_sent }}</h2>

<form action="/mark-read/{{ data.message_id }}" method="POST">
    <button type="submit">Mark as read</button>
</form>
<form action="/delete-message/{{ data.message_id }}" method="POST">
    <button type="submit">Delete message</button>
</form>
<h4>Download sender's public key to verify hashes:</h4>
<form action="/get-key" method="POST">
    <input type="hidden" name="sender" value="{{ data.sender }}">
    <button type="submit">Download</button>
</form>
<button onclick="toggleHashes()">Show / Hide hashes</button>
<p>
    Message verification status:
    {% if verified %}
        <span>Verified</span>
    {% else %}
        <span>UNVERIFIED</span>
    {% endif %}
</p>
<hr>
<h2>Message:</h2>
<p>{{ data.content }}</p>
<div class="hash-container" style="display: none;">
    <h5>Message hash:</h5>
    {{ data.content_hash }}
</div>
<hr>
<h2>Attachments:</h2>
{% if data.attachments %}
<ul class="list-group">
    {% for filename, filecontent, file_hash, _ in data.attachments %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ filename }}
        <button class="btn btn-primary btn-sm"
                onclick="downloadFile('{{ filename }}', '{{ filecontent }}')">
            Download
        </button>
        <div class="hash-container" style="display: none;">
            <h5>Attachment hash:</h5>
            <p>{{ file_hash }}</p>
        </div>
    </li>
    {% endfor %}
</ul>
{% else %}
<p>No attachments</p>
{% endif %}

<hr>

<h3>How to verify message on your own?</h3>
To ensure the message is authentic and hasn't been tampered with, follow these steps:
<ol>
    <li>Download sender's public key</li>
    <li>Use the senderâ€™s public key to decrypt the digital signature. This reveals the hash originally generated by the sender.</li>
    <li>Hash yourself message content / an attachment with SHA-256 algorithm</li>
    <li>Compare provided hash with computed one on your own</li>
    <li>If they are the same - message has not been modified. Otherwise, content may have been altered or signature is invalid. Proceed interacting with the message with <b>CAUTION</b>.</li>
</ol>
<script>
function downloadFile(filename, base64Content) {
    const byteCharacters = atob(base64Content);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);

    const blob = new Blob([byteArray], { type: 'application/octet-stream' });

    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.download = filename;

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function toggleHashes() {
    var elements = document.getElementsByClassName("hash-container");
    for (var i = 0; i < elements.length; i++) {
        if (elements[i].style.display === "none") {
            elements[i].style.display = "block";
        } else {
            elements[i].style.display = "none";
        }
    }
}
</script>
{% endblock %}