{% extends 'base.html' %}

{% block title %}Send message{% endblock %}

{% block content %}
    <h1>Send new message</h1>

    <form action="/menu" method="GET">
        <button type="submit">Go back to menu without saving</button>
    </form>

    <form id="mainForm" action="/message" method="POST" enctype="multipart/form-data">
        
        <p>
            <label for="receiver">Receiver:</label><br>
            <input type="text" id="receiver" name="receiver" required>
        </p>

        <p>
            <label for="message">Message:</label><br>
            <textarea id="message" name="message" rows="4" cols="30" required></textarea>
        </p>

        <p>
            <label for="attachment">Add attachments (you can add multiple times):</label><br>
            <input type="file" id="attachment" name="attachments" multiple>
        </p>

        <p>
            <strong>All added attachments:</strong>
            <ul id="file-list">
                <li>No files</li>
            </ul>
        </p>

        <p>
            <button type="submit">Send</button>
        </p>

    </form>

    <h4>Message requirements:</h4>
        <ul>
            <li>Message content cannot be longer than approximately 6800 characters</li>
            <li>All attachments combined cannot be larger than 25 MB</li>
        </ul>
<script>
    const fileInput = document.getElementById('attachment');
    const fileListDisplay = document.getElementById('file-list');
    const mainForm = document.getElementById('mainForm');
    let allFiles = [];

    fileInput.addEventListener('change', function(e) {
        for (let i = 0; i < this.files.length; i++) {
            allFiles.push(this.files[i]);
        }
        renderFileList();
        // Clear the file input to allow adding the same file again if needed
        this.value = "";
    });

    function renderFileList() {
        fileListDisplay.innerHTML = '';
        if (allFiles.length === 0) {
            fileListDisplay.innerHTML = '<li>No files</li>';
            return;
        }

        allFiles.forEach((file, index) => {
            const li = document.createElement('li');
            li.textContent = file.name + " (" + (file.size / (1024*1024)).toFixed(2) + " MB) ";

            const removeBtn = document.createElement('button');
            removeBtn.textContent = "Delete";
            removeBtn.type = "button";
            removeBtn.style.marginLeft = "10px";
            removeBtn.onclick = function() {
                allFiles.splice(index, 1);
                renderFileList();
            };

            li.appendChild(removeBtn);
            fileListDisplay.appendChild(li);
        });
    }

    mainForm.addEventListener('submit', function(e) {
        // Use a DataTransfer object to create a new FileList
        const dataTransfer = new DataTransfer();
        allFiles.forEach(file => {
            dataTransfer.items.add(file);
        });

        // Assign the new FileList to the file input
        fileInput.files = dataTransfer.files;

        // The form will now submit with all the files
    });
</script>
{% endblock %}